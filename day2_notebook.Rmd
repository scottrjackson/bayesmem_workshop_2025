---
title: "Bayesian Modeling and Simulation: Day 2"
date: 2025-08-19
---

# Questions/review

- ?

# Today's agenda

- Installing all the stuff
- Stan basics:
  - creating a .stan file
  - running a Stan model in R
- MCMC basics
  - chains, iter
  - inits
  - warm-up/burn-in
- Examining posterior samples
  - quantiles
  - HPDI
- Playing with our simple regression
  - play with init, warmup
  - play with priors

# Installing all the stuff

- RTools if you're on windows:

https://cran.r-project.org/bin/windows/Rtools/

LOTS of packages out there. I actually recommend loading as few as needed at a time. Many packages overlap in functionality and functions, and you can sometimes get unexpected things happening.

Core packages for running Stan:

```{r, eval = FALSE}
install.packages(c("rstan", "rstanarm"))
```

Handy additional packages we'll use:

```{r, eval = FALSE}
install.packages(c("bayesplot", "brms", "HDInterval"))
```

For the "Statistical Rethinking" textbook (not on CRAN):

```{r, eval = FALSE}
devtools::install_github("rmcelreath/rethinking")
```

## Loading for today

Today we will just load the following:

```{r}
library(rstan)
library(rstanarm)
library(ggplot2)
library(bayesplot)
library(HDInterval)
library(HistData)
```


# Stan basics
  - creating a .stan file
  - running a Stan model in R

```{r}
galton_data <- list(
  N = nrow(Galton),
  x = Galton$parent,
  y = Galton$child,
  location_intercept = 25,
  scale_intercept = 100,
  scale_slope = 20
)

galton_stan <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 2000,
  warmup = 1000
)


```


# MCMC basics
  - chains, iter
  - inits
  - warm-up/burn-in

# Examining posterior samples
  - quantiles
  - HPDI

```{r}
# fit plain lm() for comparison
galton_lm <- lm(child ~ 1 + parent, Galton)
summary(galton_lm)
str(galton_lm)

# stan fit objects are complex!
str(galton_stan)
galton_stan@inits

summary(galton_stan)
summary(galton_stan)$summary

# extract() function gets posteriors (chains)
str(extract(galton_stan))

galton_posterior_withwarmup <- extract(galton_stan, 
                          pars = c("intercept", "slope"),
                          inc_warmup = TRUE,
                          permuted = FALSE)

mcmc_trace(galton_posterior_withwarmup)

mcmc_trace(galton_stan)

galton_posterior <- extract(galton_stan, 
                          pars = c("intercept", "slope"),
                          inc_warmup = FALSE,
                          permuted = FALSE)

mcmc_trace(galton_posterior)

galton_slope_posterior <- extract(galton_stan)$slope
summary(galton_slope_posterior)

confint(galton_lm, parm = "parent", level = .95)
quantile(galton_slope_posterior, c(.025, .975))

ggplot(data = NULL, aes(galton_slope_posterior)) + geom_density()

ggplot(data = NULL, aes(galton_slope_posterior)) + geom_density() +
  geom_vline(xintercept = quantile(galton_slope_posterior, c(.025, .975)), color = "red")

hdi_interval <- hdi(galton_slope_posterior, credMass = .89)

ggplot(data = NULL, aes(galton_slope_posterior)) + geom_density() +
  geom_vline(xintercept = hdi_interval, color = "red")



```



# Playing with our simple regression
  - play with init, warmup
  - play with priors

```{r}

galton_data <- list(
  N = nrow(Galton),
  x = Galton$parent,
  y = Galton$child,
  location_intercept = 25,
  scale_intercept = 100,
  scale_slope = 20
)


galton_stan <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 2000,
  warmup = 1000
)

# 1. play with warmup length
mcmc_trace(galton_posterior_withwarmup) +
  xlim(0, 300) +
  geom_vline(xintercept = c(0, 10, 100, 200), color = "red")

galton_stan_10warmup <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 2000,
  warmup = 0
)

mcmc_trace(galton_stan_nowarmup)

galton_stan_100warmup <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 2000,
  warmup = 100
)

mcmc_trace(galton_stan_100warmup)

galton_stan_200warmup <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 2000,
  warmup = 200
)

mcmc_trace(galton_stan_200warmup)

# 2. play with keeper iterations

galton_stan_10K <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data,
  chains = 4,
  iter = 10000,
  warmup = 1000
)

galton_slope_posterior_10K <- extract(galton_stan_10K)$slope
summary(galton_slope_posterior_10K)

hdi_interval <- hdi(galton_slope_posterior_10K, credMass = .95)

ggplot(data = NULL, aes(galton_slope_posterior_10K)) + geom_density() +
  geom_vline(xintercept = hdi_interval, color = "red") +
  geom_density(aes(x = galton_slope_posterior),
               color = "steelblue", linetype = 2,
               alpha = .2)

ggplot(data = NULL, aes(galton_slope_posterior_10K)) + geom_density() +
  geom_vline(xintercept = hdi_interval, color = "red") +
  geom_density(aes(x = sample(galton_slope_posterior_10K,
                              100)),
               color = "steelblue", linetype = 2,
               alpha = .2)


# 3. play around with priors
galton_data2 <- list(
  N = nrow(Galton),
  x = Galton$parent,
  y = Galton$child,
  location_intercept = 25,
  scale_intercept = 100,
  scale_slope = .1 # narrow prior around 0
)

galton_stan2 <- stan(
  file = "simple_regression_newpars.stan",
  data = galton_data2,
  chains = 4,
  iter = 2000,
  warmup = 1000
)

galton_slope_posterior2 <- extract(galton_stan2)$slope
summary(galton_slope_posterior2)

hdi_interval <- hdi(galton_slope_posterior2, credMass = .95)

ggplot(data = NULL, aes(galton_slope_posterior2)) + geom_density() +
  geom_vline(xintercept = hdi_interval, color = "red") +
  geom_density(aes(x = galton_slope_posterior),
               color = "steelblue", linetype = 2,
               alpha = .2)



```

